import os
import numpy as np
import torch
import rasterio
import cv2
from torch.utils.data import Dataset


class SatelliteSRDataset(Dataset):
    """
    HR-first Super-Resolution Dataset for WorldStrat

    - HR images are ground truth
    - LR patches are generated by downsampling HR patches
    - Ensures perfect alignment
    """

    def __init__(self, hr_dir, lr_patch_size=128, scale=4):
        self.hr_dir = hr_dir
        self.lr_patch_size = lr_patch_size
        self.scale = scale
        self.hr_patch_size = lr_patch_size * scale

        # Collect HR files
        self.files = sorted(
            f for f in os.listdir(hr_dir) if f.endswith(".tif")
        )

        # Filter out images that are too small
        valid_files = []
        for f in self.files:
            with rasterio.open(os.path.join(hr_dir, f)) as src:
                _, h, w = src.read().shape
            if h >= self.hr_patch_size and w >= self.hr_patch_size:
                valid_files.append(f)

        self.files = valid_files

        if len(self.files) == 0:
            raise RuntimeError("No valid HR images found")

        print(f"✅ Dataset initialized with {len(self.files)} HR images")

    def __len__(self):
        return len(self.files)

    def __getitem__(self, idx):
        fname = self.files[idx]
        hr_path = os.path.join(self.hr_dir, fname)

        # Load HR image
        with rasterio.open(hr_path) as src:
            hr = src.read()  # (3, H, W)

        _, h, w = hr.shape

        # Random HR crop
        x = np.random.randint(0, w - self.hr_patch_size + 1)
        y = np.random.randint(0, h - self.hr_patch_size + 1)

        hr_patch = hr[:, y:y+self.hr_patch_size,
                         x:x+self.hr_patch_size]

        # Convert HR patch to HWC for resizing
        hr_patch_hwc = np.transpose(hr_patch, (1, 2, 0))

        # Downsample HR → LR
        lr_patch = cv2.resize(
            hr_patch_hwc,
            (self.lr_patch_size, self.lr_patch_size),
            interpolation=cv2.INTER_CUBIC
        )

        # Back to CHW
        lr_patch = np.transpose(lr_patch, (2, 0, 1))

        # Convert to tensors in [0,1]
        lr_tensor = torch.from_numpy(lr_patch).float() / 255.0
        hr_tensor = torch.from_numpy(hr_patch).float() / 255.0

        return lr_tensor, hr_tensor
